<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Bahrain Delivery - My Orders</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    
    <style>
        :root { --red: #DA291C; --bg: #f8f9fa; --input-bg: #f5f5f5; --benefit-blue: #005EB8; --success: #27ae60; }
        body { margin: 0; font-family: 'Segoe UI', Arial; background: var(--bg); overflow-x: hidden; -webkit-tap-highlight-color: transparent; }
        
        .page { 
            display: none; 
            width: 100vw; 
            height: 100vh; 
            position: fixed; 
            top: 0; 
            left: 0;
            flex-direction: column; 
            background: var(--bg);
        }
        
        .active-page { display: flex !important; }
        
        .header { 
            background: white; 
            height: 70px; 
            display: flex; 
            align-items: center; 
            padding: 0 5px; 
            border-bottom: 1px solid #eee; 
            z-index: 1000; 
            position: sticky; 
            top: 0; 
            flex-shrink: 0;
        }
        
        .back-btn { font-size: 28px; color: var(--red); cursor: pointer; border: none; background: none; width: 60px; height: 100%; display: flex; align-items: center; justify-content: center; }
        .header-title { flex: 1; text-align: center; font-weight: bold; font-size: 20px; margin-right: -60px; }
        
        .content { 
            flex: 1; 
            padding: 20px; 
            overflow-y: auto; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            -webkit-overflow-scrolling: touch;
        }
        
        .card { background: white; padding: 20px; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); width: 95%; max-width: 400px; margin-bottom: 15px; box-sizing: border-box; }
        .input-group { background: var(--input-bg); border-radius: 12px; padding: 12px; margin-bottom: 10px; border: 1px solid #ddd; width: 100%; box-sizing: border-box; display: flex; align-items: center; }
        .input-group i { color: #888; margin-left: 10px; }
        .input-group input { border: none; background: transparent; width: 100%; outline: none; text-align: right; font-size: 14px; font-family: inherit; }
        .btn-red { background: var(--red); color: white; border: none; width: 100%; padding: 18px; border-radius: 12px; font-weight: bold; cursor: pointer; font-size: 18px; margin-top: 10px; transition: 0.2s; }
        .btn-red:active { transform: scale(0.98); opacity: 0.9; }
        .btn-red:disabled { background: #ccc; cursor: not-allowed; }
        .map-frame { height: 350px; width: 100%; border-radius: 15px; margin-bottom: 15px; border: 2px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.1); z-index: 5; }
        .price-tag { background: #fff5f5; border: 2px dashed var(--red); border-radius: 15px; padding: 20px; text-align: center; width: 90%; margin-bottom: 20px; }
        .pay-methods { display: flex; gap: 10px; margin-top: 10px; width: 100%; }
        .pay-btn { flex: 1; padding: 15px; border-radius: 12px; border: 2px solid #eee; background: #f9f9f9; cursor: pointer; font-weight: bold; text-align: center; transition: 0.3s; }
        .selected-cash { border-color: var(--success) !important; background: #e8f5e9 !important; color: var(--success); }
        .selected-benefit { border-color: var(--benefit-blue) !important; background: #e3f2fd !important; color: var(--benefit-blue); }
        .order-card { background:white; border-radius:18px; margin-bottom:15px; width:100%; overflow:hidden; border:1px solid #ddd; box-shadow: 0 4px 10px rgba(0,0,0,0.05); cursor: pointer; flex-shrink: 0; }
        .gps-btn { background: white; border: 1.5px solid var(--red); color: var(--red); padding: 12px; border-radius: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%; margin-bottom: 10px; transition: 0.3s; }
        
        #full-details-overlay { 
            display: none; 
            position: fixed; 
            top: 0; left: 0; 
            width: 100%; height: 100%; 
            background: white; 
            z-index: 9999; 
            overflow-y: auto; 
            animation: slideUp 0.3s ease-out; 
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .overlay-header { display: flex; align-items: center; padding: 15px; border-bottom: 1px solid #eee; position: sticky; top: 0; background: white; z-index: 10; }
        
        .info-card-huge { 
            background: #f9f9f9; 
            padding: 20px; 
            border-radius: 15px; 
            margin-bottom: 20px; 
            border-right: 8px solid #ccc; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .details-content-huge { padding: 25px; }
    </style>
</head>
<body>

<div id="page-login" class="page active-page">
    <div class="content" style="justify-content: center;">
        <h1 style="color:var(--red); font-size: 35px; margin-bottom: 10px;">ØªÙˆØµÙŠÙ„ Ø§Ù„Ø¨Ø­Ø±ÙŠÙ†</h1>
        <p style="margin-bottom: 20px; color: #666;">Ø£Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©</p>
        <div class="card">
            <div class="input-group"><i class="fas fa-phone"></i><input type="tel" id="login-phone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ" value=""></div>
            <div class="input-group"><i class="fas fa-lock"></i><input type="password" id="login-pass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±"></div>
            <button class="btn-red" onclick="secureLogin()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
            <div style="display: flex; justify-content: center; margin-top: 20px;">
                <span>Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ </span>
                <span style="color:var(--red); cursor:pointer; font-weight:bold; margin-right:5px;" onclick="goTo('page-register')">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</span>
            </div>
        </div>
    </div>
</div>

<div id="page-register" class="page">
    <div class="header"><button class="back-btn" onclick="goTo('page-login')"><i class="fas fa-arrow-right"></i></button><div class="header-title">ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</div></div>
    <div class="content"><div class="card">
        <div class="input-group"><input type="text" id="reg-name" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„"></div>
        <div class="input-group"><input type="tel" id="reg-phone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ"></div>
        <div class="input-group"><input type="password" id="reg-pass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"></div>
        <button class="btn-red" onclick="finishRegistration()">Ø¥ØªÙ…Ø§Ù… Ø§Ù„ØªØ³Ø¬ÙŠÙ„</button>
    </div></div>
</div>

<div id="page-home" class="page">
    <div class="content" style="justify-content: center;">
        <div class="card" style="text-align: center;">
            <div style="background: #fff0f0; width: 80px; height: 80px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px;">
                <i class="fas fa-user" style="font-size: 35px; color: var(--red);"></i>
            </div>
            <h2 id="welcome-msg" style="margin-bottom: 25px;">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ</h2>
            <button class="btn-red" onclick="startNewOrder()"><i class="fas fa-plus-circle" style="margin-left: 8px;"></i>Ø·Ù„Ø¨ ØªÙˆØµÙŠÙ„ Ø¬Ø¯ÙŠØ¯</button>
            <button class="btn-red" style="background:#333; margin-top:15px;" onclick="goTo('page-history'); loadOrders();"><i class="fas fa-history" style="margin-left: 8px;"></i>Ø·Ù„Ø¨Ø§ØªÙŠ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</button>
            <button style="border:none; background:none; margin-top:25px; color:#888; font-weight: bold;" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ <i class="fas fa-sign-out-alt"></i></button>
        </div>
    </div>
</div>

<div id="page-map-pickup" class="page">
    <div class="header"><button class="back-btn" onclick="goTo('page-home')"><i class="fas fa-arrow-right"></i></button><div class="header-title">Ø§Ø¯Ø®Ù„ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… ÙÙŠ Ø®Ø§Ù†Ø© Ø§Ù„Ø¨Ø­Ø«</div></div>
    <div class="content">
        <div id="map-pickup" class="map-frame"></div>
        <button class="gps-btn" onclick="getCurrentLocation('p')"><i class="fas fa-location-arrow"></i><span>ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ (GPS)</span></button>
        <button class="btn-red" onclick="confirmStep('pickup')">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ âœ…</button>
    </div>
</div>

<div id="page-info-pickup" class="page">
    <div class="header"><button class="back-btn" onclick="goTo('page-map-pickup')"><i class="fas fa-arrow-right"></i></button><div class="header-title">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</div></div>
    <div class="content"><div class="card">
        <div class="input-group"><input type="tel" id="p-phone" placeholder="Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ø§Ù„Ù…Ø³ØªÙ„Ù… Ù…Ù†Ù‡" value=""></div>
        <div class="input-group"><input type="text" id="p-area" placeholder="Ø§Ù„Ù…Ù†Ø·Ù‚Ø©"></div>
        <div class="input-group"><input type="text" id="p-block" placeholder="Ù…Ø¬Ù…Ø¹"></div>
        <div class="input-group"><input type="text" id="p-road" placeholder="Ø·Ø±ÙŠÙ‚"></div>
        <div class="input-group"><input type="text" id="p-house" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù…Ù†Ø²Ù„ Ø§Ùˆ Ø§Ø³Ù… Ù…ÙƒØ§Ù†"></div>
        <div class="input-group"><input type="text" id="p-type" placeholder="Ø§Ù„Ø´Ù‚Ø© / Ø§Ù„Ø·Ø§Ø¨Ù‚ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"></div>
        <div class="input-group"><input type="text" id="p-link" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„Ù…ÙˆÙ‚Ø¹ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"></div>
        <button class="btn-red" onclick="goTo('page-map-delivery')">Ø§Ù„ØªØ§Ù„ÙŠ: Ù…ÙˆÙ‚Ø¹ Ø§Ù„ØªØ³Ù„ÙŠÙ…</button>
    </div></div>
</div>

<div id="page-map-delivery" class="page">
    <div class="header"><button class="back-btn" onclick="goTo('page-info-pickup')"><i class="fas fa-arrow-right"></i></button><div class="header-title">Ø§Ø¯Ø®Ù„ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ØªØ³Ù„ÙŠÙ… ÙÙŠ Ø®Ø§Ù†Ø© Ø§Ù„Ø¨Ø­Ø« </div></div>
    <div class="content">
        <div id="map-delivery" class="map-frame"></div>
        <button class="gps-btn" onclick="getCurrentLocation('d')"><i class="fas fa-location-arrow"></i><span>ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ (GPS)</span></button>
        <button class="btn-red" onclick="confirmStep('delivery')">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ âœ…</button>
    </div>
</div>

<div id="page-info-delivery" class="page">
    <div class="header"><button class="back-btn" onclick="goTo('page-map-delivery')"><i class="fas fa-arrow-right"></i></button><div class="header-title">ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØ³Ù„ÙŠÙ…</div></div>
    <div class="content"><div class="card">
        <div class="input-group" style="border: 2px solid var(--red); background: #fff;">
            <i class="fas fa-hand-holding-usd" style="color: var(--red);"></i>
            <input type="number" id="d-collection" placeholder="Ù…Ø¨Ù„Øº Ø§Ù„ØªØ­ØµÙŠÙ„ Ù…Ù† Ø§Ù„Ø²Ø¨ÙˆÙ† (Ø¯.Ø¨)">
        </div>
        <div class="input-group"><input type="tel" id="d-phone" placeholder="Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ø§Ù„Ø²Ø¨ÙˆÙ†"></div>
        <div class="input-group"><input type="text" id="d-area" placeholder="Ø§Ù„Ù…Ù†Ø·Ù‚Ø©"></div>
        <div class="input-group"><input type="text" id="d-block" placeholder="Ù…Ø¬Ù…Ø¹"></div>
        <div class="input-group"><input type="text" id="d-road" placeholder="Ø·Ø±ÙŠÙ‚"></div>
        <div class="input-group"><input type="text" id="d-house" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù…Ù†Ø²Ù„ Ø§Ùˆ Ø§Ø³Ù… Ø§Ù„Ù…ÙƒØ§Ù†"></div>
        <div class="input-group"><input type="text" id="d-type" placeholder="Ø§Ù„Ø´Ù‚Ø© / Ø§Ù„Ø·Ø§Ø¨Ù‚ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"></div>
        <div class="input-group"><input type="text" id="d-link" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„Ù…ÙˆÙ‚Ø¹ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"></div>
        <button class="btn-red" onclick="calculateFinalPrice()">Ø§Ù„ØªØ§Ù„ÙŠ: Ø§Ù„Ø¯ÙØ¹</button>
    </div></div>
</div>

<div id="page-payment" class="page">
    <div class="header"><button class="back-btn" onclick="goTo('page-info-delivery')"><i class="fas fa-arrow-right"></i></button><div class="header-title">Ø§Ù„Ø¯ÙØ¹ ÙˆØ§Ù„Ø§Ø±Ø³Ø§Ù„</div></div>
    <div class="content">
        <div class="price-tag"><h2 id="final-price">0.000 Ø¯.Ø¨</h2><small id="dist-info">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨...</small></div>
        <div class="card">
            <p style="text-align: center; font-weight: bold;">Ø§Ø®ØªØ± Ø·Ø±ÙŠÙ‚Ø© Ø¯ÙØ¹ Ø±Ø³ÙˆÙ… Ø§Ù„ØªÙˆØµÙŠÙ„</p>
            <div class="pay-methods">
                <div id="btn-cash" class="pay-btn" onclick="selectPay('Cash')"><i class="fas fa-money-bill-wave"></i><br>ÙƒØ§Ø´</div>
                <div id="btn-benefit" class="pay-btn" onclick="selectPay('Benefit')"><i class="fas fa-university"></i><br>Ø¨Ù†ÙØª</div>
            </div>
        </div>
        <div id="ben-box" class="card" style="display:none; border: 1px solid var(--benefit-blue);">
            <p style="text-align: center; font-size: 13px;">Ø­ÙˆÙ„ Ù„Ù„Ø¢ÙŠØ¨Ø§Ù† ÙˆØ£Ø±ÙÙ‚ Ø§Ù„ØµÙˆØ±Ø©:</p>
            <p style="text-align: center; background: #eee; padding: 8px; font-size: 12px; border-radius: 8px; font-family: monospace;"><b>BH98ABCO54254649101001</b></p>
            <input type="file" id="pay-img" accept="image/*" style="width: 100%; margin-top: 10px;">
        </div>
        <button id="final-send-btn" class="btn-red" style="width: 85%; opacity: 0.5;" disabled onclick="preSendCheck()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø¢Ù† ğŸš€</button>
    </div>
</div>

<div id="page-history" class="page">
    <div class="header">
        <button class="back-btn" onclick="goTo('page-home')"><i class="fas fa-arrow-right"></i></button>
        <div class="header-title">Ø·Ù„Ø¨Ø§ØªÙŠ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</div>
    </div>
    <div class="content" id="list-container" style="display: block; width: 100%; box-sizing: border-box; padding: 15px;">
        </div>
</div>

<div id="page-success" class="page"><div class="content" style="justify-content: center;"><i class="fas fa-check-circle" style="font-size:80px; color:var(--success);"></i><h2 style="margin-top: 20px;">ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­!</h2><button class="btn-red" style="width: 200px;" onclick="goTo('page-home')">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button></div></div>

<div id="full-details-overlay">
    <div class="overlay-header">
        <button onclick="closeDetails()" style="border:none; background:none; font-size:30px; color:var(--red); cursor:pointer; width: 50px;">Ã—</button>
        <h2 style="flex:1; text-align:center; margin:0; font-size: 18px;">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„ÙƒØ§Ù…Ù„Ø©</h2>
    </div>
    <div class="details-content-huge" id="details-render-area">
        </div>
</div>

<script>
    const firebaseConfig = { databaseURL: "https://bahraindelivery-2be5f-default-rtdb.firebaseio.com/" };
    if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
    const db = firebase.database();

    var mapP, markerP, mapD, markerD, selectedMethod = "", isSendingOrder = false;
    var BH_BOUNDS = { latMin: 25.70, latMax: 26.40, lngMin: 50.30, lngMax: 50.90 };

    function startNewOrder() {
        const inputs = document.querySelectorAll('input');
        inputs.forEach(input => {
            if (input.id !== 'login-phone' && input.id !== 'login-pass') {
                input.value = "";
            }
        });
        selectedMethod = "";
        const cashBtn = document.getElementById('btn-cash');
        const benBtn = document.getElementById('btn-benefit');
        const sendBtn = document.getElementById('final-send-btn');
        const benBox = document.getElementById('ben-box');
        if(cashBtn) cashBtn.className = 'pay-btn';
        if(benBtn) benBtn.className = 'pay-btn';
        if(benBox) benBox.style.display = 'none';
        if(sendBtn) {
            sendBtn.disabled = true;
            sendBtn.style.opacity = "0.5";
            sendBtn.innerText = "Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø¢Ù† ğŸš€";
        }
        if (markerP && mapP) { mapP.removeLayer(markerP); markerP = null; }
        if (markerD && mapD) { mapD.removeLayer(markerD); markerD = null; }
        goTo('page-map-pickup');
    }

    function goTo(id) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active-page'));
        document.getElementById(id).classList.add('active-page');
        if(id === 'page-map-pickup') {
            initMap('map-pickup', 'p');
            if(mapP) setTimeout(() => mapP.invalidateSize(), 400);
        }
        if(id === 'page-map-delivery') {
            initMap('map-delivery', 'd');
            if(mapD) setTimeout(() => mapD.invalidateSize(), 400);
        }
    }

    function initMap(divId, type) {
        setTimeout(() => {
            if (type === 'p' && !mapP) {
                mapP = L.map(divId).setView([26.2285, 50.5860], 12);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mapP);
                L.Control.geocoder({ 
                    defaultMarkGeocode: true, 
                    placeholder: "Ø§Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¨Ø­Ø±ÙŠÙ†...", 
                    geocoder: L.Control.Geocoder.nominatim({ geocodingQueryParams: { countrycodes: 'bh' } }) 
                }).on('markgeocode', e => {
                    if(markerP) mapP.removeLayer(markerP);
                    markerP = L.marker(e.geocode.center).addTo(mapP);
                    mapP.setView(e.geocode.center, 16);
                }).addTo(mapP);
                mapP.on('click', e => {
                    if(markerP) mapP.removeLayer(markerP);
                    markerP = L.marker(e.latlng).addTo(mapP);
                });
            } else if (type === 'd' && !mapD) {
                mapD = L.map(divId).setView([26.2285, 50.5860], 12);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mapD);
                L.Control.geocoder({ 
                    defaultMarkGeocode: true, 
                    placeholder: "Ø§Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¨Ø­Ø±ÙŠÙ†...", 
                    geocoder: L.Control.Geocoder.nominatim({ geocodingQueryParams: { countrycodes: 'bh' } }) 
                }).on('markgeocode', e => {
                    if(markerD) mapD.removeLayer(markerD);
                    markerD = L.marker(e.geocode.center).addTo(mapD);
                    mapD.setView(e.geocode.center, 16);
                }).addTo(mapD);
                mapD.on('click', e => {
                    if(markerD) mapD.removeLayer(markerD);
                    markerD = L.marker(e.latlng).addTo(mapD);
                });
            }
        }, 300);
    }

    function getCurrentLocation(type) {
        if (!navigator.geolocation) return alert("Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… GPS");
        navigator.geolocation.getCurrentPosition(pos => {
            const lat = pos.coords.latitude; const lng = pos.coords.longitude;
            if (lat >= BH_BOUNDS.latMin && lat <= BH_BOUNDS.latMax && lng >= BH_BOUNDS.lngMin && lng <= BH_BOUNDS.lngMax) {
                const loc = [lat, lng];
                if (type === 'p') {
                    if(markerP) mapP.removeLayer(markerP);
                    markerP = L.marker(loc).addTo(mapP); mapP.setView(loc, 17);
                } else {
                    if(markerD) mapD.removeLayer(markerD);
                    markerD = L.marker(loc).addTo(mapD); mapD.setView(loc, 17);
                }
            } else { alert("Ù…ÙˆÙ‚Ø¹Ùƒ Ø®Ø§Ø±Ø¬ Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø¨Ø­Ø±ÙŠÙ†"); }
        }, () => alert("ÙØ´Ù„ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ - ØªØ£ÙƒØ¯ Ù…Ù† ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙÙŠ Ù‡Ø§ØªÙÙƒ"), {enableHighAccuracy: true});
    }

    function sendNow(img) {
        if (isSendingOrder) return;
        const pPhone = document.getElementById('p-phone').value.trim();
        const pArea = document.getElementById('p-area').value.trim();
        const pBlock = document.getElementById('p-block').value.trim();
        const pRoad = document.getElementById('p-road').value.trim();
        const pHouse = document.getElementById('p-house').value.trim();
        const dPhone = document.getElementById('d-phone').value.trim();
        const dArea = document.getElementById('d-area').value.trim();
        const dBlock = document.getElementById('d-block').value.trim();
        const dRoad = document.getElementById('d-road').value.trim();
        const dHouse = document.getElementById('d-house').value.trim();
        const dCollection = document.getElementById('d-collection').value.trim();

        if(!pPhone || !pArea || !pBlock || !pRoad || !pHouse || !dPhone || !dArea || !dBlock || !dRoad || !dHouse) {
            return alert("ÙŠØ±Ø¬Ù‰ Ø¥ÙƒÙ…Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥Ø¬Ø¨Ø§Ø±ÙŠØ©");
        }

        isSendingOrder = true;
        const btn = document.getElementById('final-send-btn');
        btn.disabled = true; btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...";

        let orderId = "ORD" + Date.now();
        let data = {
            id: orderId,
            user: localStorage.getItem('uPhone') || pPhone,
            status: 'waiting',
            method: selectedMethod,
            proofImage: img || "",
            price: document.getElementById('final-price').innerText,
            collectionAmount: dCollection || "0",
            pPhone, pArea, pRoad, pBlock, pHouse,
            pType: document.getElementById('p-type').value,
            pLink: document.getElementById('p-link').value,
            pickup: `https://www.google.com/maps?q=${markerP.getLatLng().lat},${markerP.getLatLng().lng}`,
            dPhone, dArea, dRoad, dBlock, dHouse,
            dType: document.getElementById('d-type').value,
            dLink: document.getElementById('d-link').value,
            dropoff: `https://www.google.com/maps?q=${markerD.getLatLng().lat},${markerD.getLatLng().lng}`,
            timestamp: Date.now()
        };

        db.ref('orders/' + orderId).set(data).then(() => {
            isSendingOrder = false;
            goTo('page-success');
        }).catch(() => { isSendingOrder = false; btn.disabled = false; btn.innerText = "Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø¢Ù† ğŸš€"; });
    }

    function confirmStep(step) {
        if (step === 'pickup' && !markerP) return alert("Ø­Ø¯Ø¯ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…");
        if (step === 'delivery' && !markerD) return alert("Ø­Ø¯Ø¯ Ù…ÙˆÙ‚Ø¹ Ø§Ù„ØªØ³Ù„ÙŠÙ…");
        goTo(step === 'pickup' ? 'page-info-pickup' : 'page-info-delivery');
    }

    // --- Ø¯Ø§Ù„Ø© Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¹Ø¯Ù„Ø© Ø­Ø³Ø¨ Ø·Ù„Ø¨Ùƒ: 0.125 Ù„ÙƒÙ„ ÙƒÙŠÙ„Ùˆ ---
    function calculateFinalPrice() {
        if(!markerP || !markerD) return alert("ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ Ø£ÙˆÙ„Ø§Ù‹");
        
        let rawDist = markerP.getLatLng().distanceTo(markerD.getLatLng()) / 1000;
        
        // 1. ØªÙ‚Ø±ÙŠØ¨ Ø§Ù„Ù…Ø³Ø§ÙØ© Ù„Ù„Ø£Ø¯Ù†Ù‰ (Floor)
        let roundedDist = Math.floor(rawDist);
        
        // 2. Ø§Ù„Ø­Ø³Ø§Ø¨: ÙƒÙ„ ÙƒÙŠÙ„Ùˆ Ø¨Ù€ 0.125 Ø¯ÙŠÙ†Ø§Ø±
        let calcPrice = roundedDist * 0.125;
        
        // 3. Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„ØªÙˆØµÙŠÙ„ 0.750 Ø¯ÙŠÙ†Ø§Ø±
        let finalPrice = Math.max(calcPrice, 0.750).toFixed(3);
        
        document.getElementById('dist-info').innerText = "Ø§Ù„Ù…Ø³Ø§ÙØ© (Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ‚Ø±ÙŠØ¨): " + roundedDist + " ÙƒÙ…";
        document.getElementById('final-price').innerText = finalPrice + " Ø¯.Ø¨";
        goTo('page-payment');
    }

    function selectPay(m) {
        selectedMethod = m;
        document.getElementById('btn-cash').className = 'pay-btn' + (m === 'Cash' ? ' selected-cash' : '');
        document.getElementById('btn-benefit').className = 'pay-btn' + (m === 'Benefit' ? ' selected-benefit' : '');
        document.getElementById('ben-box').style.display = (m === 'Benefit' ? 'block' : 'none');
        document.getElementById('final-send-btn').disabled = false;
        document.getElementById('final-send-btn').style.opacity = "1";
    }

    async function preSendCheck() {
        let imgData = "";
        if(selectedMethod === 'Benefit') {
            const file = document.getElementById('pay-img').files[0];
            if(!file) return alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø±ÙØ§Ù‚ ØµÙˆØ±Ø© Ø§Ù„ØªØ­ÙˆÙŠÙ„");
            imgData = await new Promise(r => { const rd = new FileReader(); rd.readAsDataURL(file); rd.onload = () => r(rd.result); });
        }
        sendNow(imgData);
    }

    function loadOrders() {
        let userPhone = localStorage.getItem('uPhone');
        let list = document.getElementById('list-container');
        list.innerHTML = "<p style='text-align:center;'>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø·Ù„Ø¨Ø§ØªÙƒ...</p>";
        db.ref('orders').orderByChild('user').equalTo(userPhone).on('value', snap => {
            list.innerHTML = "";
            if (!snap.exists()) { list.innerHTML = "<p style='text-align:center;'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø³Ø§Ø¨Ù‚Ø©</p>"; return; }
            let orders = []; snap.forEach(c => { let o = c.val(); o.key = c.key; orders.push(o); });
            orders.sort((a,b) => b.timestamp - a.timestamp).forEach(o => {
                let statusText = getStatusText(o.status);
                list.innerHTML += `
                    <div class="order-card" onclick='openOrderDetails(${JSON.stringify(o)})'>
                        <div style="padding:15px; display:flex; justify-content:space-between; align-items:center;">
                            <div>
                                <b style="font-size:16px;">Ø·Ù„Ø¨ #${o.key.slice(-5)}</b><br>
                                <small style="color:#888;">${new Date(o.timestamp).toLocaleDateString('ar-BH')}</small>
                            </div>
                            <div style="text-align:left;">
                                <span style="color:var(--red); font-weight:bold;">${statusText}</span><br>
                                <b style="color:#333;">${o.price}</b>
                            </div>
                        </div>
                    </div>`;
            });
            list.innerHTML += `<div style="height:80px; width:100%;"></div>`;
        });
    }

    function getStatusText(s) {
        if(s === 'waiting') return "Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±";
        if(s === 'accepted') return "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ¬Ù‡ÙŠØ² ğŸšš";
        if(s === 'picked') return "Ø§Ø³ØªÙ„Ù… Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ ğŸ";
        if(s === 'completed') return "ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ… âœ…";
        if(s === 'canceled') return "Ù…Ù„ØºÙŠ âŒ";
        return "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
    }

    function openOrderDetails(o) {
        let statusT = getStatusText(o.status);
        let cancelBtn = (o.status === 'waiting' || o.status === 'accepted') ? `<button class="btn-red" onclick="cancelOrder('${o.key}'); closeDetails();">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨ ğŸ—‘ï¸</button>` : "";
        let driverInfo = o.driverName ? `<div class="info-card-huge" style="border-right-color:var(--benefit-blue); background:#e3f2fd;"><b>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨:</b><br>${o.driverName} | <a href="tel:${o.driverPhone}">Ø§ØªØµØ§Ù„ ğŸ“</a></div>` : "";

        document.getElementById('details-render-area').innerHTML = `
            <div class="info-card-huge" style="border-right-color:var(--red);">
                <b>Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨:</b> <span style="color:var(--red); font-weight:bold; font-size:18px;">${statusT}</span>
            </div>
            <div class="info-card-huge" style="border-right-color:#ff9800; background: #fffbe6;">
                <b style="color:#e65100;"><i class="fas fa-hand-holding-usd"></i> Ù…Ø¨Ù„Øº Ø§Ù„ØªØ­ØµÙŠÙ„ Ù…Ù† Ø§Ù„Ø²Ø¨ÙˆÙ†:</b><br>
                <span style="font-size: 22px; font-weight: bold;">${o.collectionAmount || "0"} Ø¯.Ø¨</span>
            </div>
            <div class="info-card-huge" style="border-right-color:var(--red);">
                <b style="color:var(--red);">ğŸ“ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… (Ù…Ù†):</b><br>
                ${o.pArea}, Ù…Ø¬Ù…Ø¹ ${o.pBlock}, Ø·Ø±ÙŠÙ‚ ${o.pRoad}, Ù…Ù†Ø²Ù„ ${o.pHouse}<br>
                <small>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ: ${o.pPhone}</small>
            </div>
            <div class="info-card-huge" style="border-right-color:var(--success);">
                <b style="color:var(--success);">ğŸ Ù…ÙˆÙ‚Ø¹ Ø§Ù„ØªØ³Ù„ÙŠÙ… (Ø¥Ù„Ù‰):</b><br>
                ${o.dArea}, Ù…Ø¬Ù…Ø¹ ${o.dBlock}, Ø·Ø±ÙŠÙ‚ ${o.dRoad}, Ù…Ù†Ø²Ù„ ${o.dHouse}<br>
                <small>Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ø§Ù„Ø²Ø¨ÙˆÙ†: ${o.dPhone}</small>
            </div>
            <div class="info-card-huge" style="text-align:center; background:#fff5f5; border-right-color:var(--red);">
                <b>Ø±Ø³ÙˆÙ… Ø§Ù„ØªÙˆØµÙŠÙ„:</b><br>
                <span style="font-size:24px; color:var(--red); font-weight:bold;">${o.price}</span>
            </div>
            ${driverInfo}
            ${cancelBtn}
            <div style="height:50px;"></div>
        `;
        document.getElementById('full-details-overlay').style.display = 'block';
    }

    function closeDetails() { document.getElementById('full-details-overlay').style.display = 'none'; }
    function cancelOrder(key) { if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨ØŸ")) db.ref('orders/'+key).update({status:'canceled'}); }
    
    function secureLogin() {
        let ph = document.getElementById('login-phone').value.trim();
        let ps = document.getElementById('login-pass').value.trim();
        db.ref('users/' + ph).once('value', s => {
            if(s.exists() && s.val().password === ps) { localStorage.setItem('uPhone', ph); goTo('page-home'); }
            else alert("Ø®Ø·Ø£ ÙÙŠ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
        });
    }

    function finishRegistration() {
        let ph = document.getElementById('reg-phone').value.trim();
        let nm = document.getElementById('reg-name').value.trim();
        let ps = document.getElementById('reg-pass').value.trim();
        if(ph && nm && ps) db.ref('users/'+ph).set({name: nm, password: ps}).then(() => {
            alert("ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­!");
            goTo('page-login');
        });
        else alert("ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„");
    }

    function logout() { localStorage.clear(); location.reload(); }
</script>
</body>
</html>